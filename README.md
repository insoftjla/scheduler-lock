# Scheduler Lock

Java-библиотека для блокировки выполнения плановых задач. Она позволяет гарантировать, что запланированный метод будет выполнен только одним экземпляром приложения в заданный интервал времени. Блокировки хранятся в таблице базы данных, поэтому подход работает в распределённой среде.

## Возможности

- Аннотация `@ScheduledLock` для указания уникального имени блокировки и времени жизни.
- Проверка и установка блокировки реализована через аспект `SchedulerLock` и `AspectJ`.
- Время удержания блокировки может задаваться напрямую в аннотации или через properties.
- Хранение информации о блокировках в таблице `scheduler_lock`.

## Установка

```gradle
implementation 'ru.insoftjla.locker:SchedulerLock:1.1.2'
```

## Настройка

1. Создайте таблицу для хранения блокировок:

```sql
CREATE TABLE scheduler_lock (
  name            VARCHAR(255) PRIMARY KEY,
  locked_at       TIMESTAMP NOT NULL,
  locked_granted  TIMESTAMP NOT NULL
);
```

2. Определите бин `DataSource` и создайте DAO:

```java
SchedulerLockDao dao = new SchedulerLockDao(dataSource);
SchedulerLock schedulerLock = new SchedulerLock(dao);
```

3. При необходимости передайте в `SchedulerLock` файл настроек, где ключом будет значение параметра `duration` из аннотации, а значением — длительность блокировки в формате ISO‑8601 (`1M`, `30S` и т.д.).

## Использование

Аннотируйте метод, который выполняется по расписанию:

```java
@ScheduledLock(name = "myJob", duration = "5M")
public void myJob() {
    // тело задачи
}
```

При запуске метод будет выполнен только если в таблице отсутствует активная блокировка с именем `myJob`. Если запись существует и её срок действия ещё не истёк, выполнение будет пропущено.

## Лицензия

MIT
